<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人投資記帳系統 v2.5 (Google雲端同步版)</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { 'stock-up': '#ef4444', 'stock-down': '#22c55e', 'gray-bg': '#f3f4f6' } }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, Component } = React;

        // --- Error Boundary ---
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            render() {
                if (this.state.hasError) return <div className="p-8 text-center"><h1 className="text-xl font-bold text-red-600">系統發生錯誤</h1><button onClick={() => window.location.reload()} className="mt-4 px-4 py-2 bg-blue-600 text-white rounded">重整</button></div>;
                return this.props.children;
            }
        }

        const STOCK_MAP = [
            { code: '2330', name: '台積電' }, { code: '2317', name: '鴻海' }, { code: '2454', name: '聯發科' },
            { code: '2303', name: '聯電' }, { code: '2881', name: '富邦金' }, { code: '2882', name: '國泰金' },
            { code: '2308', name: '台達電' }, { code: '2412', name: '中華電' }, { code: '1301', name: '台塑' },
            { code: '0050', name: '元大台灣50' }, { code: '0056', name: '元大高股息' }, { code: '00878', name: '國泰永續高股息' },
            { code: '00929', name: '復華台灣科技優息' }, { code: '00919', name: '群益台灣精選高息' }
        ];

        // --- Icons ---
        const IconTrendingDown = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></svg>;
        const IconDollarSign = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>;
        const IconBriefcase = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>;
        const IconCloud = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>;
        const IconUploadCloud = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="16 16 12 12 8 16"></polyline><line x1="12" y1="12" x2="12" y2="21"></line><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"></path><polyline points="16 16 12 12 8 16"></polyline></svg>;
        const IconDownloadCloud = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="8 17 12 21 16 17"></polyline><line x1="12" y1="12" x2="12" y2="21"></line><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"></path><polyline points="8 17 12 21 16 17"></polyline></svg>;
        const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;
        const IconPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const IconFilter = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>;

        const formatCurrency = (val) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(val || 0);
        const formatPercent = (val) => ((val || 0) * 100).toFixed(2) + "%";
        const getToday = () => new Date().toISOString().split('T')[0];
        const getFirstDayOfYear = () => new Date(new Date().getFullYear(), 0, 1).toISOString().split('T')[0];
        const addDays = (d, days) => { const date = new Date(d); date.setUTCDate(date.getUTCDate() + days); return date.toISOString().split('T')[0]; };

        // --- Chart Components ---
        const PieChart = ({ data }) => {
            if (!data || data.length === 0) return <div className="text-gray-400 text-center text-sm py-10">無數據</div>;
            const total = data.reduce((acc, item) => acc + item.value, 0);
            if (total <= 0) return <div className="text-gray-400 text-center text-sm py-10">總資產為 0</div>;
            let cumulativePercent = 0;
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6'];
            const getCoords = (p) => [Math.cos(2 * Math.PI * p), Math.sin(2 * Math.PI * p)];
            return (
                <div className="flex flex-row items-center justify-center gap-8">
                    <div className="relative w-40 h-40">
                        <svg viewBox="-1 -1 2 2" className="transform -rotate-90 w-full h-full">
                            {data.map((slice, i) => {
                                const start = cumulativePercent;
                                const end = cumulativePercent + (slice.value / total);
                                cumulativePercent = end;
                                const [sX, sY] = getCoords(start);
                                const [eX, eY] = getCoords(end);
                                const largeArc = end - start > 0.5 ? 1 : 0;
                                return <path key={i} d={`M 0 0 L ${sX} ${sY} A 1 1 0 ${largeArc} 1 ${eX} ${eY} L 0 0`} fill={colors[i % colors.length]} stroke="white" strokeWidth="0.02" />;
                            })}
                        </svg>
                    </div>
                    <div className="flex flex-col gap-1 text-xs">
                        {data.map((slice, i) => (
                            <div key={i} className="flex items-center gap-2"><div className="w-3 h-3 rounded-full" style={{ backgroundColor: colors[i % colors.length] }}></div><span className="font-medium text-gray-700">{slice.label}</span><span className="text-gray-500">{Math.round((slice.value / total) * 100)}%</span></div>
                        ))}
                    </div>
                </div>
            );
        };
        const BarChart = ({ data }) => {
            if (!data || data.length === 0) return <div className="text-gray-400 text-center text-sm py-10">無數據</div>;
            const maxVal = Math.max(...data.map(d => Math.abs(d.value)));
            const height = 150; const barWidth = 30; const gap = 15;
            return (
                <div className="overflow-x-auto">
                    <svg height={height} width={data.length * (barWidth + gap)} className="mx-auto">
                        <line x1="0" y1={height/2} x2="100%" y2={height/2} stroke="#e5e7eb" strokeWidth="1" />
                        {data.map((d, i) => {
                            const h = maxVal === 0 ? 0 : (Math.abs(d.value) / maxVal) * (height / 2 - 20);
                            const y = d.value >= 0 ? (height / 2) - h : height / 2;
                            return (
                                <g key={i}>
                                    <rect x={i * (barWidth + gap)} y={y} width={barWidth} height={h} fill={d.value >= 0 ? '#ef4444' : '#22c55e'} opacity="0.8" rx="2" />
                                    <text x={i * (barWidth + gap) + barWidth/2} y={height/2 + (d.value >=0 ? 15 : -5)} textAnchor="middle" fontSize="10" fill="#6b7280" transform={d.value >= 0 ? `translate(0, ${h})` : `translate(0, -${h})`}>{formatCurrency(d.value)}</text>
                                    <text x={i * (barWidth + gap) + barWidth/2} y={height - 5} textAnchor="middle" fontSize="10" fill="#9ca3af">{d.label}</text>
                                </g>
                            );
                        })}
                    </svg>
                </div>
            );
        };

        const App = () => {
            // Local Data
            const [accounts, setAccounts] = useState(() => JSON.parse(localStorage.getItem('investment_accounts')) || ['預設帳戶']);
            const [currentAccount, setCurrentAccount] = useState(() => localStorage.getItem('investment_current_account') || '預設帳戶');
            const [transactions, setTransactions] = useState(() => {
                const t = JSON.parse(localStorage.getItem('investment_transactions')) || [];
                return t.map(x => ({...x, accountId: x.accountId || '預設帳戶'}));
            });
            const [currentPrices, setCurrentPrices] = useState(() => JSON.parse(localStorage.getItem('investment_prices')) || {});
            
            // Cloud Config
            const [gasUrl, setGasUrl] = useState(() => localStorage.getItem('investment_gas_url') || '');
            const [isCloudModalOpen, setIsCloudModalOpen] = useState(false);
            const [isLoading, setIsLoading] = useState(false);

            // UI State
            const [view, setView] = useState('dashboard');
            const [dateFilter, setDateFilter] = useState({ start: getFirstDayOfYear(), end: getToday() });
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalMode, setModalMode] = useState('buy');
            const [formData, setFormData] = useState({ date: getToday(), symbol: '', name: '', price: '', quantity: '', fee: '', tax: '', note: '' });

            useEffect(() => localStorage.setItem('investment_transactions', JSON.stringify(transactions)), [transactions]);
            useEffect(() => localStorage.setItem('investment_prices', JSON.stringify(currentPrices)), [currentPrices]);
            useEffect(() => localStorage.setItem('investment_accounts', JSON.stringify(accounts)), [accounts]);
            useEffect(() => localStorage.setItem('investment_current_account', currentAccount), [currentAccount]);
            useEffect(() => localStorage.setItem('investment_gas_url', gasUrl), [gasUrl]);

            const portfolio = useMemo(() => {
                let cash = 0, totalInvested = 0, holdings = {}, periodRealizedPnL = 0, periodDividend = 0, periodFees = 0, periodTax = 0, monthlyPnL = {};
                const accountTx = transactions.filter(t => t.accountId === currentAccount);
                const sortedTx = [...accountTx].sort((a, b) => new Date(a.date) - new Date(b.date));

                sortedTx.forEach(tx => {
                    const total = (parseFloat(tx.price||0)*parseFloat(tx.quantity||0)), fee = parseFloat(tx.fee||0), tax = parseFloat(tx.tax||0);
                    if (tx.type === 'deposit') { cash += total; totalInvested += total; }
                    else if (tx.type === 'withdraw') { cash -= total; totalInvested -= total; }
                    else if (tx.type === 'dividend') { cash += total; }
                    else if (tx.type === 'buy') {
                        const cost = total + fee; cash -= cost;
                        if (!holdings[tx.symbol]) holdings[tx.symbol] = { qty: 0, cost: 0, name: tx.name };
                        holdings[tx.symbol].qty += parseFloat(tx.quantity); holdings[tx.symbol].cost += cost; holdings[tx.symbol].name = tx.name || holdings[tx.symbol].name;
                    } else if (tx.type === 'sell') {
                        const revenue = total - fee - tax; cash += revenue;
                        if (holdings[tx.symbol]) {
                            const avg = holdings[tx.symbol].qty > 0 ? holdings[tx.symbol].cost / holdings[tx.symbol].qty : 0;
                            holdings[tx.symbol].qty -= parseFloat(tx.quantity); holdings[tx.symbol].cost -= (avg * parseFloat(tx.quantity));
                        }
                    }
                });

                let tempHoldings = {};
                sortedTx.forEach(tx => {
                    const d = new Date(tx.date); const inPeriod = d >= new Date(dateFilter.start) && d <= new Date(dateFilter.end);
                    const total = (parseFloat(tx.price||0)*parseFloat(tx.quantity||0)), fee = parseFloat(tx.fee||0), tax = parseFloat(tx.tax||0), m = tx.date.substring(0, 7);
                    if (inPeriod) { periodFees += fee; periodTax += tax; if (tx.type === 'dividend') { periodDividend += total; monthlyPnL[m] = (monthlyPnL[m]||0) + total; } }
                    if (tx.type === 'buy') {
                        if (!tempHoldings[tx.symbol]) tempHoldings[tx.symbol] = { qty: 0, cost: 0 };
                        tempHoldings[tx.symbol].qty += parseFloat(tx.quantity); tempHoldings[tx.symbol].cost += (total + fee);
                    } else if (tx.type === 'sell') {
                        if (tempHoldings[tx.symbol]) {
                            const avg = tempHoldings[tx.symbol].qty > 0 ? tempHoldings[tx.symbol].cost / tempHoldings[tx.symbol].qty : 0;
                            const realized = (total - fee - tax) - (avg * parseFloat(tx.quantity));
                            if (inPeriod) { periodRealizedPnL += realized; monthlyPnL[m] = (monthlyPnL[m]||0) + realized; }
                            tempHoldings[tx.symbol].qty -= parseFloat(tx.quantity); tempHoldings[tx.symbol].cost -= (avg * parseFloat(tx.quantity));
                        }
                    }
                });

                let marketValue = 0, totalUnrealizedPnL = 0, holdingsArray = [], assetAllocation = [];
                Object.keys(holdings).forEach(s => {
                    const h = holdings[s];
                    if (h.qty > 0.0001) {
                        const cur = parseFloat(currentPrices[s]) || (h.cost / h.qty);
                        const val = cur * h.qty; const un = val - h.cost;
                        marketValue += val; totalUnrealizedPnL += un;
                        holdingsArray.push({ symbol: s, name: h.name, qty: h.qty, avgCost: h.cost/h.qty, currentPrice: cur, marketValue: val, unrealizedPnL: un, roi: h.cost > 0 ? un/h.cost : 0 });
                        assetAllocation.push({ label: h.name || s, value: val });
                    }
                });
                if (cash > 0) assetAllocation.push({ label: '現金', value: cash });
                assetAllocation.sort((a,b) => b.value - a.value);
                const totalAssets = cash + marketValue;
                
                return { cash, marketValue, totalAssets, totalInvested, totalPnL: totalAssets - totalInvested, totalUnrealizedPnL, roi: totalInvested > 0 ? (totalAssets - totalInvested)/totalInvested : 0, holdings: holdingsArray, periodRealizedPnL, periodDividend, periodFees, periodTax, periodTotalPnL: periodRealizedPnL + periodDividend, assetAllocation, monthlyPnLData: Object.keys(monthlyPnL).sort().map(k => ({ label: k.slice(5), value: monthlyPnL[k] })) };
            }, [transactions, currentPrices, currentAccount, dateFilter]);

            // Cloud Logic
            const saveToCloud = async () => {
                if (!gasUrl) return alert("請先設定 Google Apps Script 網址");
                if (!confirm("確定要將本機資料「覆蓋」到雲端嗎？")) return;
                setIsLoading(true);
                try {
                    const payload = { transactions, currentPrices, accounts };
                    await fetch(gasUrl, { method: 'POST', body: JSON.stringify(payload) }); // No-cors mode is tricky, standard fetch works if script deployed as 'Anyone'
                    alert("上傳成功！");
                    setIsCloudModalOpen(false);
                } catch (e) { alert("上傳失敗: " + e); }
                setIsLoading(false);
            };
            const loadFromCloud = async () => {
                if (!gasUrl) return alert("請先設定 Google Apps Script 網址");
                if (!confirm("確定要從雲端下載並「覆蓋」本機資料嗎？")) return;
                setIsLoading(true);
                try {
                    const res = await fetch(gasUrl);
                    const data = await res.json();
                    if (data.transactions) {
                        setTransactions(data.transactions);
                        setCurrentPrices(data.currentPrices || {});
                        if(data.accounts) setAccounts(data.accounts);
                        alert("同步成功！");
                        setIsCloudModalOpen(false);
                    } else { alert("雲端沒有有效資料"); }
                } catch (e) { alert("下載失敗: " + e); }
                setIsLoading(false);
            };

            const handleSellSymbolChange = (e) => {
                const s = e.target.value; const h = portfolio.holdings.find(x => x.symbol === s);
                setFormData(p => ({ ...p, symbol: s, name: h ? h.name : '', quantity: '', fee: '0', tax: '0' }));
            };
            const handleInputChange = (e) => {
                const { name, value } = e.target;
                let n = { ...formData, [name]: value };
                if ((modalMode === 'buy' || modalMode === 'sell') && (name === 'price' || name === 'quantity')) {
                    const p = parseFloat(name === 'price' ? value : formData.price) || 0;
                    const q = parseFloat(name === 'quantity' ? value : formData.quantity) || 0;
                    const t = p * q;
                    if(name === 'price' || name === 'quantity') { n.fee = Math.max(20, Math.floor(t * 0.001425)); n.tax = modalMode === 'sell' ? Math.floor(t * 0.003) : 0; }
                }
                setFormData(n);
            };
            const handleSubmit = (e) => {
                e.preventDefault();
                if (modalMode === 'sell') {
                    const h = portfolio.holdings.find(x => x.symbol === formData.symbol);
                    if (!h) return alert("無庫存");
                    if (parseFloat(formData.quantity) > h.qty) return alert("庫存不足");
                }
                const newTx = { id: Date.now(), accountId: currentAccount, type: modalMode, ...formData, price: parseFloat(formData.price), quantity: parseFloat(formData.quantity) || 1 };
                setTransactions([...transactions, newTx]);
                if (modalMode === 'buy' && formData.symbol) setCurrentPrices(p => ({...p, [formData.symbol]: parseFloat(formData.price)}));
                setIsModalOpen(false);
            };
            const currentHolding = modalMode === 'sell' ? portfolio.holdings.find(h => h.symbol === formData.symbol) : null;
            const isQtyOver = modalMode === 'sell' && currentHolding && parseFloat(formData.quantity) > currentHolding.qty;

            return (
                <ErrorBoundary>
                <div className="min-h-screen pb-20">
                    <div className="bg-gray-800 text-white px-4 py-2 flex justify-between items-center text-sm">
                        <div className="flex items-center space-x-2">
                            <span>帳戶:</span>
                            <select value={currentAccount} onChange={(e) => setCurrentAccount(e.target.value)} className="bg-gray-700 rounded px-1"><option value={currentAccount}>{currentAccount}</option></select>
                        </div>
                        <button onClick={() => setIsCloudModalOpen(true)} className="flex items-center gap-1 bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-xs font-bold shadow">
                            <IconCloud /> 雲端同步
                        </button>
                    </div>

                    <header className="bg-white shadow-sm sticky top-0 z-10 border-b border-gray-200">
                        <div className="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center space-x-2"><div className="bg-blue-600 text-white p-2 rounded-lg"><IconBriefcase /></div><h1 className="text-xl font-bold text-gray-800">投資紀錄</h1></div>
                            <div className="flex items-center bg-gray-50 p-1 rounded-lg border text-sm"><IconFilter /><input type="date" value={dateFilter.start} onChange={(e)=>setDateFilter({...dateFilter, start: e.target.value})} className="bg-transparent w-28 mx-1" />➜<input type="date" value={dateFilter.end} onChange={(e)=>setDateFilter({...dateFilter, end: e.target.value})} className="bg-transparent w-28 mx-1" /></div>
                        </div>
                    </header>

                    <div className="max-w-5xl mx-auto px-4 mt-6">
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div className="bg-white p-4 rounded-xl shadow-sm border"><div className="text-gray-500 text-xs">總資產</div><div className="text-xl font-bold">{formatCurrency(portfolio.totalAssets)}</div></div>
                            <div className="bg-white p-4 rounded-xl shadow-sm border"><div className="text-gray-500 text-xs">庫存市值</div><div className="text-xl font-bold">{formatCurrency(portfolio.marketValue)}</div></div>
                            <div className="bg-white p-4 rounded-xl shadow-sm border"><div className="text-gray-500 text-xs">現金</div><div className="text-xl font-bold">{formatCurrency(portfolio.cash)}</div></div>
                            <div className="bg-white p-4 rounded-xl shadow-sm border"><div className="text-gray-500 text-xs">總損益</div><div className={`text-xl font-bold ${portfolio.totalPnL>0?'text-stock-up':'text-stock-down'}`}>{formatCurrency(portfolio.totalPnL)}</div></div>
                        </div>

                        <div className="flex space-x-1 mb-4 overflow-x-auto pb-2">
                            {['dashboard', 'account_pnl', 'cash_flow', 'holdings', 'history'].map(tab => <button key={tab} onClick={() => setView(tab)} className={`px-4 py-2 rounded-md text-sm whitespace-nowrap ${view === tab ? 'bg-blue-100 text-blue-700' : 'bg-white text-gray-600'}`}>{{'dashboard':'儀表板','account_pnl':'損益','cash_flow':'流水帳','holdings':'庫存','history':'明細'}[tab]}</button>)}
                        </div>

                        <div className="bg-white rounded-xl shadow-sm border min-h-[400px]">
                            <div className="p-4 border-b flex gap-2 overflow-x-auto">
                                <button onClick={() => {setModalMode('buy');setIsModalOpen(true)}} className="flex items-center space-x-1 px-4 py-2 bg-red-500 text-white rounded text-sm"><IconPlus /><span>買入</span></button>
                                <button onClick={() => {setModalMode('sell');setIsModalOpen(true)}} className="flex items-center space-x-1 px-4 py-2 bg-green-500 text-white rounded text-sm"><IconTrendingDown /><span>賣出</span></button>
                                <button onClick={() => {setModalMode('dividend');setIsModalOpen(true)}} className="px-4 py-2 bg-yellow-500 text-white rounded text-sm"><IconDollarSign /></button>
                                <div className="w-px bg-gray-200 mx-2"></div>
                                <button onClick={() => {setModalMode('deposit');setIsModalOpen(true)}} className="px-3 py-2 bg-gray-100 text-gray-700 rounded text-sm">入金</button>
                                <button onClick={() => {setModalMode('withdraw');setIsModalOpen(true)}} className="px-3 py-2 bg-gray-100 text-gray-700 rounded text-sm">出金</button>
                            </div>

                            <div className="p-0 overflow-x-auto">
                                {view === 'dashboard' && <div className="p-6"><div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8"><PieChart data={portfolio.assetAllocation} /><BarChart data={portfolio.monthlyPnLData} /></div></div>}
                                {view === 'account_pnl' && <div className="p-6"><div className="text-3xl font-bold mb-4 text-center">{formatCurrency(portfolio.periodTotalPnL)}</div><div className="grid grid-cols-2 gap-4"><div className="p-3 bg-gray-50">價差: {formatCurrency(portfolio.periodRealizedPnL)}</div><div className="p-3 bg-yellow-50">股息: {formatCurrency(portfolio.periodDividend)}</div></div></div>}
                                {view === 'holdings' && <table className="w-full text-sm text-left"><thead className="bg-gray-50 text-gray-500"><tr><th className="p-3">代號</th><th className="p-3 text-right">股數</th><th className="p-3 text-right">現價</th><th className="p-3 text-right">損益</th></tr></thead><tbody>{portfolio.holdings.map(h=><tr key={h.symbol} className="border-b"><td className="p-3 font-bold">{h.name}<div className="text-xs font-normal text-gray-400">{h.symbol}</div></td><td className="p-3 text-right">{h.qty}</td><td className="p-3 text-right"><input type="number" className="w-16 text-right border rounded bg-yellow-50" value={h.currentPrice} onChange={(e)=>setCurrentPrices(p=>({...p,[h.symbol]:e.target.value}))}/></td><td className={`p-3 text-right font-bold ${h.unrealizedPnL>0?'text-stock-up':'text-stock-down'}`}>{formatCurrency(h.unrealizedPnL)}</td></tr>)}</tbody></table>}
                                {(view === 'history' || view === 'cash_flow') && <table className="w-full text-sm text-left"><thead className="bg-gray-50 text-gray-500"><tr><th className="p-3">日期</th><th className="p-3">項目</th><th className="p-3 text-right">金額</th><th className="p-3"></th></tr></thead><tbody>{transactions.filter(t=>t.accountId===currentAccount).sort((a,b)=>new Date(b.date)-new Date(a.date)).map(t=>{ const total=(t.price*t.quantity);const net=t.type==='buy'?-(total+t.fee):t.type==='sell'?(total-t.fee-t.tax):t.type==='withdraw'?-total:total;return(<tr key={t.id} className="border-b"><td className="p-3 text-xs text-gray-500">{t.date}</td><td className="p-3"><div><span className={`text-xs px-1 rounded ${t.type==='buy'?'bg-red-100 text-red-700':t.type==='sell'?'bg-green-100 text-green-700':'bg-gray-100'}`}>{{buy:'買',sell:'賣',dividend:'息',deposit:'入',withdraw:'出'}[t.type]}</span> {t.name||t.symbol}</div></td><td className={`p-3 text-right font-bold ${net>0?'text-stock-up':'text-stock-down'}`}>{formatCurrency(Math.abs(net))}</td><td className="p-3"><button onClick={()=>{if(confirm('刪除?'))setTransactions(transactions.filter(x=>x.id!==t.id))}} className="text-gray-300 hover:text-red-500">×</button></td></tr>)})}</tbody></table>}
                            </div>
                        </div>
                    </div>

                    {/* Trade Modal */}
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
                                <h2 className="text-xl font-bold mb-4">新增紀錄</h2>
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <input type="date" name="date" required className="border rounded p-2 w-full" value={formData.date} onChange={handleInputChange} />
                                        {(modalMode!=='deposit'&&modalMode!=='withdraw') && (modalMode==='sell' ? <select name="symbol" required className="border rounded p-2 w-full" value={formData.symbol} onChange={handleSellSymbolChange}><option value="">選股</option>{portfolio.holdings.map(h=><option key={h.symbol} value={h.symbol}>{h.name}</option>)}</select> : <input type="text" name="symbol" placeholder="代號" required className="border rounded p-2 w-full" value={formData.symbol} onChange={(e)=>{const m=STOCK_MAP.find(s=>s.code===e.target.value);setFormData({...formData,symbol:e.target.value,name:m?m.name:formData.name})}} />)}
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <input type="number" name="price" placeholder="價格/金額" required className="border rounded p-2 w-full" value={formData.price} onChange={handleInputChange} />
                                        {(modalMode==='buy'||modalMode==='sell') && <div className="relative"><input type="number" name="quantity" placeholder="股數" required className={`border rounded p-2 w-full ${isQtyOver?'border-red-500 bg-red-50':''}`} value={formData.quantity} onChange={handleInputChange} />{modalMode==='sell'&&currentHolding&&<button type="button" onClick={()=>handleInputChange({target:{name:'quantity',value:currentHolding.qty}})} className="absolute right-2 top-2 text-xs text-blue-500">最大</button>}</div>}
                                    </div>
                                    <div className="flex justify-end gap-2 pt-4"><button type="button" onClick={()=>setIsModalOpen(false)} className="px-4 py-2 bg-gray-100 rounded">取消</button><button type="submit" disabled={isQtyOver} className="px-4 py-2 bg-blue-600 text-white rounded">確定</button></div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Cloud Sync Modal */}
                    {isCloudModalOpen && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl shadow-xl max-w-sm w-full p-6">
                                <h2 className="text-xl font-bold mb-2 flex items-center gap-2"><IconCloud /> 雲端同步中心</h2>
                                <p className="text-xs text-gray-500 mb-4">使用 Google 試算表作為資料庫，讓手機與電腦資料互通。</p>
                                
                                <label className="block text-sm font-bold text-gray-700 mb-1">Google Apps Script 網址</label>
                                <input type="text" placeholder="https://script.google.com/..." className="w-full border rounded p-2 mb-4 text-sm" value={gasUrl} onChange={(e) => setGasUrl(e.target.value)} />
                                
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={saveToCloud} disabled={isLoading} className="flex flex-col items-center justify-center p-4 border rounded-lg hover:bg-blue-50 text-blue-700 border-blue-200 transition">
                                        {isLoading ? <div className="loader mb-2"></div> : <IconUploadCloud className="mb-2 w-8 h-8" />}
                                        <span className="font-bold">上傳 (覆寫雲端)</span>
                                        <span className="text-xs text-gray-400 mt-1">本機 ➜ Google</span>
                                    </button>
                                    <button onClick={loadFromCloud} disabled={isLoading} className="flex flex-col items-center justify-center p-4 border rounded-lg hover:bg-green-50 text-green-700 border-green-200 transition">
                                        {isLoading ? <div className="loader mb-2"></div> : <IconDownloadCloud className="mb-2 w-8 h-8" />}
                                        <span className="font-bold">下載 (覆寫本機)</span>
                                        <span className="text-xs text-gray-400 mt-1">Google ➜ 本機</span>
                                    </button>
                                </div>
                                <button onClick={() => setIsCloudModalOpen(false)} className="mt-4 w-full py-2 text-gray-500 text-sm hover:bg-gray-100 rounded">關閉</button>
                            </div>
                        </div>
                    )}
                </div>
                </ErrorBoundary>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>